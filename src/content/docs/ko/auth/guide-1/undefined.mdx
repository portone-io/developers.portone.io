---
emoji: ğŸª§
title: ë¹Œë§í‚¤ë¥¼ ì´ìš©í•œ ì •ê¸°ê²°ì œ
description: customer_uid ë¡œ ì •ê¸°(ì˜ˆì•½)ê²°ì œ êµ¬í˜„ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
---

import * as prose from "~/components/prose";
export const components = prose;

import Hint from "~/components/gitbook/Hint.astro";
import Tabs from "~/components/gitbook/tabs/Tabs.astro";
import Tab from "~/components/gitbook/tabs/Tab.astro";

#### [ë¹Œë§í‚¤ ë°œê¸‰](../../api/api-2/api-1) ë˜ëŠ” [ë¹„ ì¸ì¦ ê²°ì œ(ì¼íšŒì„±)](../../api/api-4/api-1) APIë¥¼ ì´ìš©í•˜ì—¬ customer_uid ë¥¼ íšë“í–ˆë‹¤ë©´ ì›í•˜ëŠ” í˜•íƒœì˜ ì •ê¸° ë˜ëŠ” ì˜ˆì•½ê²°ì œë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### <mark style="color:blue;">**STEP 01.**</mark> ê²°ì œ ì˜ˆì•½í•˜ê¸°

ë¯¸ë˜ íŠ¹ì • ì‹œì ì— ê²°ì œê°€ ì§„í–‰ë˜ë„ë¡ ê²°ì œë¥¼ ì˜ˆì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í¬íŠ¸ì› <mark style="color:blue;">**ê²°ì œ ì˜ˆì•½ API**</mark>ë¥¼ ì´ìš©í•˜ì—¬ ì›í•˜ì‹œëŠ” ì‹œì ì— ê²°ì œ ì˜ˆì•½ì„ ì†ì‰½ê²Œ ë“±ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<Tabs>
<Tab title="server-side">
```javascript title="Node.js"
// ê²°ì œ ì˜ˆì•½
  axios({
    url: \`https://api.iamport.kr/subscribe/payments/schedule\`,
    method: "post",
    headers: { "Authorization": access_token }, 
    data: {
      customer_uid: "gildong_0001_1234", // ì¹´ë“œ(ë¹Œë§í‚¤)ì™€ 1:1ë¡œ ëŒ€ì‘í•˜ëŠ” ê°’
      schedules: [
        {
          merchant_uid: "order_monthly_0001", // ì£¼ë¬¸ ë²ˆí˜¸
          schedule_at: 1519862400, // ê²°ì œ ì‹œë„ ì‹œê° in Unix Time Stamp. ì˜ˆ: ë‹¤ìŒ ë‹¬ 1ì¼
          amount: 8900,
          name: "ì›”ê°„ ì´ìš©ê¶Œ ì •ê¸°ê²°ì œ",
          buyer_name: "í™ê¸¸ë™",
          buyer_tel: "01012345678",
          buyer_email: "gildong@gmail.com"
        }
      ]
    }
  });
```

</Tab>
</Tabs>

### <mark style="color:blue;">**STEP 02.**</mark> ê²°ì œ ê²°ê³¼ ìˆ˜ì‹ ë°›ê¸°

ì˜ˆì•½í•œ ì‹œê°„ì— ê²°ì œê°€ ì‹œë„ë˜ë©´ Webhook ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì—¬ ì§€ì •í•œ ì„œë²„ì˜ callback URLë¡œ ê²°ì œ ë²ˆí˜¸(`imp_uid`)ì™€ ì£¼ë¬¸ ë²ˆí˜¸(`merchant_uid`)ê°€ ì „ë‹¬ë©ë‹ˆë‹¤. ì›¹í›…ìœ¼ë¡œ ì˜ˆì•½ê²°ì œì— ëŒ€í•œ ê²°ê³¼ë¥¼ ìˆ˜ì‹ ìœ¼ë©´ ê²°ì œê²°ê³¼ ì™„ë£Œ ë¡œì§ ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

<Hint style="info">
**í¬íŠ¸ì› Webhook**

í¬íŠ¸ì› Webhookì˜ ê°œë…ê³¼ URL ì„¤ì • ë°©ë²•ì€ [**í¬íŠ¸ì› Webhook**](../../result/webhook) ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

</Hint>

<Tabs>
<Tab title="Node.js">
```javascript title="server-side"
// "/iamport-callback/schedule"ì— ëŒ€í•œ POST ìš”ì²­ì„ ì²˜ë¦¬
    app.post("/iamport-callback/schedule", async (req, res) => {
      try {
        const { imp_uid, merchant_uid } = req.body;
        // ì•¡ì„¸ìŠ¤ í† í°(access token) ë°œê¸‰ ë°›ê¸°
        const getToken = await axios({
          url: "https://api.iamport.kr/users/getToken",
          method: "post", // POST method
          headers: { "Content-Type": "application/json" }, 
          data: {
            imp_key: "imp_apikey", // REST API í‚¤
            imp_secret: "ekKoeW8RyKuT0zgaZsUtXXTLQ4AhPFW3ZGseDA6bkA5lamv9OqDMnxyeB9wqOsuO9W3Mx9YSJ4dTqJ3f" 
          }
        });
        const { access_token } = getToken.data; // ì¸ì¦ í† í°
        // imp_uidë¡œ í¬íŠ¸ì› ì„œë²„ì—ì„œ ê²°ì œ ì •ë³´ ì¡°íšŒ
        const getPaymentData = await axios({
          url: \`https://api.iamport.kr/payments/\${imp_uid}\`, // imp_uid ì „ë‹¬
          method: "get", // GET method
          headers: { "Authorization": access_token } 
        });
        const paymentData = getPaymentData.data; // ì¡°íšŒí•œ ê²°ì œ ì •ë³´
        const { status } = paymentData;
        if (status === "paid") { // ê²°ì œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ
          // DBì— ê²°ì œ ì •ë³´ ì €ì¥
          await Orders.findByIdAndUpdate(merchant_uid, { $set: paymentData }); // Mongoose
          ...
        } else {
          // ì¬ê²°ì œ ì‹œë„
        }
      } catch (e) {
        res.status(400).send(e);
      }
    });
```

</Tab>
</Tabs>

### ë°˜ë³µê²°ì œ êµ¬í˜„í•˜ê¸°

í¬íŠ¸ì› ì„œë²„ì— ê²°ì œ ì˜ˆì•½ ìš”ì²­ì„ í•˜ê³  ì˜ˆì•½í•œ ì‹œê°„ì— ê²°ì œê°€ ì‹œë„ë˜ë©´ ì§€ì •ëœ ì›¹í›… URLì„ í†µí•´ì„œ ì„œë²„ì— ì•Œë¦¬ëŠ” ê³¼ì •ì„ ë°˜ë³µì ìœ¼ë¡œ ìˆ˜í–‰í•˜ì—¬ ë°˜ë³µ ê²°ì œë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](</gitbook-assets/ko/image (170).png>)

<Tabs>
<Tab title="Node.js">
```javascript title="server-side"
// "/iamport-callback/schedule"ì— ëŒ€í•œ POST ìš”ì²­ì„ ì²˜ë¦¬
    app.post("/iamport-callback/schedule", async (req, res) => {
      try {
        const { imp_uid, merchant_uid } = req.body;
        // ì•¡ì„¸ìŠ¤ í† í°(access token) ë°œê¸‰ ë°›ê¸°
        /* ...ì¤‘ëµ ... */
        // imp_uidë¡œ í¬íŠ¸ì› ì„œë²„ì—ì„œ ê²°ì œ ì •ë³´ ì¡°íšŒ
        /* ...ì¤‘ëµ ... */
        const paymentData = getPaymentData.data; // ì¡°íšŒí•œ ê²°ì œ ì •ë³´
        const { status } = paymentData;
        if (status === "paid") { // ê²°ì œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ
          // DBì— ê²°ì œ ì •ë³´ ì €ì¥
          await Orders.findByIdAndUpdate(merchant_uid, { $set: paymentData }); 
          ...
          // ìƒˆë¡œìš´ ê²°ì œ ì˜ˆì•½
          axios({
            url: "{ê²°ì œì˜ˆì•½ì„ ë°›ì„ ì„œë¹„ìŠ¤ URL}", 
            method: "post",
            // ì¸ì¦ í† í° Authorization headerì— ì¶”ê°€
            headers: { "Authorization": access_token }, 
            data: {
              customer_uid: "gildong_0001_1234", // ì¹´ë“œ(ë¹Œë§í‚¤)ì™€ 1:1ë¡œ ëŒ€ì‘í•˜ëŠ” ê°’
              schedules: [
                {
                  // ì£¼ë¬¸ ë²ˆí˜¸
                  merchant_uid: "order_monthly_0001", 
                  // ê²°ì œ ì‹œë„ ì‹œê° in Unix Time Stamp. ì˜ˆ: ë‹¤ìŒ ë‹¬ 1ì¼
                  schedule_at: 1519516800, 
                  amount: 8900,
                  name: "ì›”ê°„ ì´ìš©ê¶Œ ì •ê¸°ê²°ì œ",
                  ...
                }
              ]
            }
          });
        } else {
          // ì¬ê²°ì œ ì‹œë„
        }
      } catch (e) {
        res.status(400).send(e);
      }
    });
```

ì˜ˆì•½ëœ ê²°ì œê°€ ì‹œë„ë˜ì—ˆì„ ë•Œ ë°œìƒí•˜ëŠ” webhook ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì—ì„œ ì˜ˆì•½ëœ ê²°ì œê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ê³  ê²°ì œ ë‚´ì—­ì´ ì €ì¥ë˜ë©´ ë‹¤ìŒ ê²°ì œë¥¼ ì˜ˆì•½í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.

</Tab>
</Tabs>
