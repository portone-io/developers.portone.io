---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { format } from "date-fns";
import LayoutKo from "~/layouts/LayoutKo.astro";
import authors from "~/content/blog/_authors.yaml";
import * as prose from "~/components/blog/prose";
import ProfileImage from "~/components/blog/ProfileImage.astro";

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  return blogEntries.map((entry) => {
    return {
      params: { slug: entry.slug },
      props: { entry, slug: entry.slug },
    };
  });
}

const { entry } = Astro.props;
const { title, author: authorId } = entry.data;
const { Content } = await entry.render();

const author = authors[authorId];
---

<LayoutKo title={`${title} - PortOne 기술블로그`}>
  <article class="max-w-900px text-slate-7 mx-auto my-4 pb-40">
    <div class="flex flex-col gap-6 px-4 md:px-6">
      {
        entry.data.tags.length > 0 && (
          <ul class="m-0 flex list-none flex-row flex-wrap gap-2 p-0">
            {entry.data.tags.map((tag) => (
              <li class="bg-#11182780 inline-block w-fit rounded-md px-2 py-1 text-sm font-medium text-slate-50">
                <a href={`/blog/tags/${encodeURIComponent(tag)}`}>{tag}</a>
              </li>
            ))}
          </ul>
        )
      }
      <div class="flex flex-col gap-4">
        <div class="text-slate-4 text-base font-medium">
          {format(entry.data.date, "MMM d, yyyy")}
        </div>
        <div class="flex justify-between">
          <h1 class="text-balance break-keep text-3xl font-bold leading-[1.4]">
            {title}
          </h1>
          {
            author && (
              <dl class="flex shrink-0 items-center gap-4">
                <div>
                  <ProfileImage>
                    <Image
                      src={`https://github.com/${authorId}.png`}
                      alt={`Avatar image of ${author.name}`}
                      width={48}
                      height={48}
                      class="bg-slate-2 h-12 w-12 rounded-full"
                    />
                  </ProfileImage>
                </div>
                <div class="flex flex-col justify-evenly whitespace-nowrap">
                  <dt class="text-slate-7 text-lg font-semibold">
                    {author.name}
                  </dt>
                  <dd class="text-slate-4 text-lg">{author.position}</dd>
                </div>
              </dl>
            )
          }
        </div>
      </div>
      <div class="body text-slate-7">
        <Content components={prose} />
        <style>
          article .body :global(:is(ol, ul)) {
            margin-top: 32px;
            margin-bottom: 32px;
          }

          article .body :global(ol) > :global(li:has(:is(ol, ul))) {
            margin-top: 10px;
            margin-bottom: 10px;
          }

          article .body :global(:is(ol, ul)) :global(:is(ol, ul)) {
            margin-top: 10px;
            margin-bottom: 10px;
          }

          article
            .body
            :global(:is([data-rehype-pretty-code-fragment], figure)) {
            margin: 40px 0;
          }
        </style>
      </div>
    </div>
  </article>
</LayoutKo>
