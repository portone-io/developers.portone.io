---
import { getCollection } from "astro:content";

import redirYaml from "~/content/docs/_redir.yaml";
import Docs from "~/layouts/Docs.astro";
import { isLang } from "~/type";

const { lang, slug } = Astro.params;
if (!isLang(lang) || !slug) {
  return new Response(null, { status: 404 });
}

const absSlug = `/${lang}/${slug}`;
const redir = redirYaml.find(({ old }) => old === absSlug);
if (redir) {
  return new Response(null, {
    status: 301,
    headers: { Location: redir.new },
  });
}

const entries = await getCollection("docs");
const entry = entries.find((entry) => entry.slug === `${lang}/${slug}`);
if (!entry) return new Response(null, { status: 404 });
---

<Docs lang={lang} slug={absSlug} entry={entry} />
